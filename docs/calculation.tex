\documentclass{scrartcl}

\usepackage{listings}
\usepackage{amsmath}

\title{CosmoAI model}
\author{Hans Georg Schaathun}

\begin{document}
\maketitle


\section{Images}

The simulator maintains three images.

\begin{enumerate}
   \item The actual source.  This is an image of the remote galaxy drawn with
      the origin in the line of sight through the centre of the lens.
      Its centre of mass is at $P_{\mathrm{ACT}}$.
   \item The apparent source, used only as an intermediate calculation.  
      It is the actual source, translated so that it lies behind the distorted
      image as seen by the observer, and then rotated to fall on the $x$ axis.
   \item The distorted image.  This is the image seen.  It is drawn in a coordinate
      system in the lens plane, with the origin in the centre of mass of the lens.
\end{enumerate}

\section{Variables and Parameters}

\begin{center}
   \begin{tabular}{p{3cm}|p{6.5cm}|p{4cm}}
\hline
  Class Variables & Mathematical Notation & Calculation \\
\hline
\hline
   \texttt{CHI}       & $\chi=\frac{chi_L}{\chi_S}$      & User Setting \\
\hline
   \texttt{size}      & Image size (not part of the model) & User Setting \\
\hline
   \texttt{einsteinR} & $R_E$                              & User Setting \\
\hline
   \texttt{sourceSize} & $\sigma$                          & User Setting \\
\hline
   \texttt{nterms}    & Number of terms after truncation    & User Setting \\
\hline
   \texttt{actualX}, \texttt{actualY} & $P_{\textrm{ACT}}$  & User Setting\\
\hline
   \texttt{apparentX}, \texttt{apparentY} 
         & $P_{\textrm{APP}}=\rho_1P_{\textrm{ACT}}$ 
         & \texttt{updateXY()} -- not used \\
\hline
   \texttt{actualAbs} & $||P_{\textrm{ACT}}||$ & \texttt{updateXY()} \\
\hline
   \texttt{apparentAbs} & $||P_{\textrm{APP}}||=\rho_1||P_{\textrm{ACT}}||$
      & \texttt{updateXY()} \\
\hline
   \texttt{alphas\_val[m][s]},
   \texttt{betas\_val[m][s]}  & $\alpha,\beta$ \textbf{TODO}
        (floating point values)
        & \texttt{calculateAlphaBeta()} \\
\hline
   \texttt{alphas\_v[m][s]},
   \texttt{betas\_l[m][s]}  & $\alpha,\beta$ \textbf{TODO}
        (algebraic expressions)
        & \texttt{initAlphaBeta()} loading from \texttt{50.txt} \\
\hline
\end{tabular}
\end{center}

\begin{center}
   \begin{tabular}{p{2cm}|p{7cm}|p{4.5cm}}
\hline
   Intermediate Variables & Mathematical Notation & Calculation \\
\hline
\hline
   \texttt{xi1}, \texttt{xi2}       & Cartesian coordinates $\xi=(\xi_1,\xi_2)$ of a point in the apparent source.  Should possibly be $\eta$     & Return value from \texttt{getDistortedPos} \\
\hline
   \texttt{ratio1}, \texttt{ratio2} & $\rho_1,\rho_2$   & \texttt{updateXY}        \\
\hline
   \texttt{r}, \texttt{theta} & Polar coordinates $(r,\theta)$ of a point in the distorted image (lens plane) relative to the centre of mass of the distorted image &
      Arguments to \texttt{getDistortedPos()} \\
\hline
      \texttt{c\_p} & $c_+=1+s/(m+1)$ & \texttt{getDistortedPos()} \\
\hline
      \texttt{c\_m} & $c_+=1-s/(m+1)$ & \texttt{getDistortedPos()} \\
\hline
\hline
\end{tabular}
\end{center}

\section{The \texttt{distort()} function}

\begin{lstlisting}
void Simulator::distort(int begin, int end, const cv::Mat& src, cv::Mat& dst) {
    // Iterate over the pixels in the image distorted image.
    // (row,col) are pixel co-ordinates
    for (int row = begin; row < end; row++) {
        for (int col = 0; col < dst.cols; col++) {

            int row_, col_;  // pixel co-ordinates in the apparent image
            std::pair<double, double> pos ;

            // Set coordinate system with origin at x=R
            double x = (col - apparentAbs - dst.cols / 2.0) * CHI;
            double y = (dst.rows / 2.0 - row) * CHI;

            // Calculate distance and angle of the point evaluated 
            // relative to center of lens (origin)
            double r = sqrt(x * x + y * y);
            double theta = atan2(y, x);

            pos = this->getDistortedPos(r, theta);

            // Translate to array index
            row_ = (int) round(src.rows / 2.0 - pos.second);
            col_ = (int) round(apparentAbs + src.cols / 2.0 + pos.first);

            // If (x', y') within source, copy value to imgDistorted
            if (row_ < src.rows && col_ < src.cols && row_ >= 0 && col_ >= 0) {
                auto val = src.at<uchar>(row_, col_);
                dst.at<uchar>(row, col) = val;
            }
        }
    }
}
\end{lstlisting}

Suppose the distorted image is an $m\times n$ matrix.
We rewrite the pixel coordinates $(i,j)$ as $(x,y)$ to get
a canonical Cartesian coordinate system centered at
the apparent location of the source.
\begin{align}
     x &= (j - ||P_{APP}|| - n/2)\cdot\chi \\
     y &= (-i + m/2)\cdot\chi 
\end{align}
Given the Cartesian coordinates $(x,y)$, we find Polar coordinates
$(r,\theta)$ as
\begin{align}
   r &= \sqrt{x^2+y^2}\\
   \theta &= 
     \begin{cases}
        \tan^{-1} \frac{y}{x}, \text{ if } x\ge0\\
        \pi + \tan^{-1} \frac{y}{x}, \text{ if } x<0
     \end{cases}
\end{align}

The \texttt{getDistortedPos} method implements the main coordinate distortion
functions and map $(r, \theta) \mapsto \xi = (\xi_1,\xi_2)$.

\begin{itemize}
   \item \textbf{TODO} There is a likely scaling error in this formula.
   \item \textbf{TODO} We should use $\eta$ for the position in the source plane and
        $\xi$ in the lens plane.  Then $\xi=\chi\eta$.
        This is not done consistently at the moment.
\end{itemize}

\end{document}
